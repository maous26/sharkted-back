services:
  caddy:
    image: caddy:2-alpine
    container_name: sharkted-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - api

  api:
    build: .
    container_name: sharkted-api
    restart: unless-stopped
    ports:
      - "127.0.0.1:3000:3000"
    environment:
      - DATABASE_URL=postgresql+psycopg://sharkted:b70d44323564d812e19f178ab33b69f8@db:5432/sharkted
      - JWT_SECRET=7fd58fc6369dc8b60c6ae8584515fa68f58428ec34067baf4bff4fb2d3b1296e
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    depends_on:
      - db
    working_dir: /app
    volumes:
      - .:/app
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "3000", "--proxy-headers", "--forwarded-allow-ips", "*"]

  db:
    image: postgres:16
    container_name: sharkted-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: sharkted
      POSTGRES_USER: sharkted
      POSTGRES_PASSWORD: b70d44323564d812e19f178ab33b69f8
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: sharkted-redis
    restart: unless-stopped
    ports:
      - "127.0.0.1:6379:6379"

  
  worker_high:
    build: .
    container_name: sharkted-worker-high
    restart: unless-stopped
    working_dir: /app
    volumes:
      - .:/app
    environment:
      - DATABASE_URL=postgresql+psycopg://sharkted:b70d44323564d812e19f178ab33b69f8@db:5432/sharkted
      - JWT_SECRET=7fd58fc6369dc8b60c6ae8584515fa68f58428ec34067baf4bff4fb2d3b1296e
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - REDIS_URL=redis://redis:6379/0
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    depends_on:
      - db
      - redis
    command: ["python", "worker.py", "high"]

  worker_default:
    build: .
    container_name: sharkted-worker-default
    restart: unless-stopped
    working_dir: /app
    volumes:
      - .:/app
    environment:
      - DATABASE_URL=postgresql+psycopg://sharkted:b70d44323564d812e19f178ab33b69f8@db:5432/sharkted
      - JWT_SECRET=7fd58fc6369dc8b60c6ae8584515fa68f58428ec34067baf4bff4fb2d3b1296e
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - REDIS_URL=redis://redis:6379/0
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    depends_on:
      - db
      - redis
    command: ["python", "worker.py", "default"]

  worker_low:
    build: .
    container_name: sharkted-worker-low
    restart: unless-stopped
    working_dir: /app
    volumes:
      - .:/app
    environment:
      - DATABASE_URL=postgresql+psycopg://sharkted:b70d44323564d812e19f178ab33b69f8@db:5432/sharkted
      - JWT_SECRET=7fd58fc6369dc8b60c6ae8584515fa68f58428ec34067baf4bff4fb2d3b1296e
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - REDIS_URL=redis://redis:6379/0
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    depends_on:
      - db
      - redis
    command: ["python", "worker.py", "low"]



  scheduler:
    build: .
    container_name: sharkted-scheduler
    restart: unless-stopped
    working_dir: /app
    volumes:
      - .:/app
    environment:
      - REDIS_URL=redis://redis:6379/0
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - DATABASE_URL=postgresql+psycopg://sharkted:b70d44323564d812e19f178ab33b69f8@db:5432/sharkted
      - JWT_SECRET=7fd58fc6369dc8b60c6ae8584515fa68f58428ec34067baf4bff4fb2d3b1296e
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    depends_on:
      - redis
    command: ["rqscheduler", "--url", "redis://redis:6379/0", "--interval", "5"]





volumes:
  pgdata:
  caddy_data:
  caddy_config:

